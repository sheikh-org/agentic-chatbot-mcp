name: Playwright Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [18.x, 20.x]
        browser: [chromium, firefox, webkit]
        
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps ${{ matrix.browser }}
      
    - name: Install system dependencies
      run: npx playwright install-deps
      
    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production
        
    - name: Run Playwright tests
      run: npm run test -- --project=${{ matrix.browser }}
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.browser }}-${{ matrix.node-version }}
        path: playwright-report/
        retention-days: 30
        
    - name: Upload test screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-screenshots-${{ matrix.browser }}-${{ matrix.node-version }}
        path: test-results/
        retention-days: 7

  accessibility-tests:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright
      run: npx playwright install --with-deps chromium
      
    - name: Run accessibility tests
      run: npm run test -- tests/accessibility.spec.ts --project=chromium
      
    - name: Upload accessibility report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: accessibility-report
        path: playwright-report/
        retention-days: 30

  api-tests:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright
      run: npx playwright install --with-deps chromium
      
    - name: Start application
      run: npm run dev &
      
    - name: Wait for application to be ready
      run: npx wait-on http://localhost:3000 --timeout 60000
      
    - name: Run API tests
      run: npm run test -- tests/api-endpoints.spec.ts --project=chromium --headed=false
      
    - name: Upload API test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-test-results
        path: playwright-report/
        retention-days: 30

  mobile-tests:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device: [Mobile Chrome, Mobile Safari]
        
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright
      run: npx playwright install --with-deps
      
    - name: Run mobile tests
      run: npm run test -- --project="${{ matrix.device }}"
      
    - name: Upload mobile test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mobile-test-results-${{ matrix.device }}
        path: playwright-report/
        retention-days: 7

  performance-tests:
    timeout-minutes: 45
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright
      run: npx playwright install --with-deps chromium
      
    - name: Run performance tests
      run: |
        npx playwright test tests/accessibility.spec.ts \
          --project=chromium \
          --reporter=json \
          --output=performance-results.json
          
    - name: Analyze performance results
      run: |
        node -e "
        const fs = require('fs');
        const results = JSON.parse(fs.readFileSync('performance-results.json', 'utf8'));
        
        const avgDuration = results.stats.duration / results.stats.total;
        const maxDuration = Math.max(...results.suites.flatMap(s => 
          s.specs.flatMap(sp => sp.tests.map(t => t.duration))
        ));
        
        console.log(\`Average test duration: \${avgDuration}ms\`);
        console.log(\`Maximum test duration: \${maxDuration}ms\`);
        
        if (avgDuration > 5000) {
          console.warn('‚ö†Ô∏è Tests are running slower than expected');
        }
        
        if (maxDuration > 10000) {
          console.warn('‚ö†Ô∏è Some tests are taking longer than 10 seconds');
        }
        "
        
    - name: Upload performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: performance-results.json
        retention-days: 7

  security-scan:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run security audit
      run: npm audit --audit-level=high
      
    - name: Check for vulnerabilities
      run: |
        if npm audit --audit-level=high | grep -q "vulnerabilities found"; then
          echo "::error::High severity vulnerabilities detected"
          exit 1
        fi
        
    - name: Upload audit results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-audit
        path: audit-report.json
        retention-days: 7

  lint-and-typecheck:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run ESLint
      run: npm run lint
      
    - name: Run TypeScript type check
      run: npm run type-check
      
    - name: Upload lint results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lint-results
        path: .
        retention-days: 7

  test-summary:
    needs: [test, accessibility-tests, api-tests, mobile-tests, performance-tests, security-scan, lint-and-typecheck]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Create test summary
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üéØ Test Execution Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check main tests
        if [ -d "playwright-report-chromium-18" ] || [ -d "playwright-report-chromium-20" ]; then
          echo "‚úÖ **Browser Tests**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Browser Tests**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d "accessibility-report" ]; then
          echo "‚úÖ **Accessibility Tests**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Accessibility Tests**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d "api-test-results" ]; then
          echo "‚úÖ **API Tests**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **API Tests**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d "mobile-test-results-Mobile Chrome" ] || [ -d "mobile-test-results-Mobile Safari" ]; then
          echo "‚úÖ **Mobile Tests**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Mobile Tests**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîí Security & Quality" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "lint-results" ]; then
          echo "‚úÖ **Linting & Type Checking**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Linting & Type Checking**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üì± Tested Configurations" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Browsers**: Chromium, Firefox, Webkit" >> $GITHUB_STEP_SUMMARY
        echo "- **Node.js**: 18.x, 20.x" >> $GITHUB_STEP_SUMMARY
        echo "- **Mobile**: Chrome & Safari on iOS/Android" >> $GITHUB_STEP_SUMMARY
        echo "- **Accessibility**: WCAG compliance testing" >> $GITHUB_STEP_SUMMARY
        echo "- **Performance**: Load time and responsiveness" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.test.result }}" == "success" && 
              "${{ needs.accessibility-tests.result }}" == "success" && 
              "${{ needs.api-tests.result }}" == "success" && 
              "${{ needs.mobile-tests.result }}" == "success" && 
              "${{ needs.security-scan.result }}" == "success" && 
              "${{ needs.lint-and-typecheck.result }}" == "success" ]]; then
          echo "## üéâ All Tests Passed!" >> $GITHUB_STEP_SUMMARY
          echo "The application is ready for deployment." >> $GITHUB_STEP_SUMMARY
        else
          echo "## ‚ö†Ô∏è Some Tests Failed" >> $GITHUB_STEP_SUMMARY
          echo "Please check the individual test results and fix any issues." >> $GITHUB_STEP_SUMMARY
        fi

  deploy:
    needs: [test-summary]
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/main' && 
      needs.test-summary.result == 'success'
    environment: production
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build for production
      run: npm run build
      env:
        NODE_ENV: production
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        
    - name: Deploy to production
      run: |
        echo "üöÄ Deployment would happen here"
        echo "Current branch: ${{ github.ref }}"
        echo "Environment: production"
        # Add your deployment commands here
        # Examples:
        # - aws s3 sync build/ s3://your-bucket
        # - fly deploy
        # - docker push && docker run
        # etc.
        
    - name: Post-deployment verification
      run: |
        echo "‚úÖ Deployment completed successfully!"
        echo "üîç Running post-deployment smoke tests..."
        # Add post-deployment verification steps here